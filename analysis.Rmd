---
title: "Feature Analysis"
author: "Catherine C. Pollack"
date: "5/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r}
library(tidyverse)
library(magrittr) #%<>%
library(data.table) #fread
library(ggsci)
library(lsr) #eta squared
library(apaTables) #partial eta squared
library(BSDA) #tsum.test
library(lsr) #Cohen's d
library(broom)
library(Rtsne) #Move up if keep this
library(ggpubr)
library(cowplot)
```

# Bring in Data
```{r}
setwd("/Volumes/LaCie/Reddit Data New")
metadata <- fread("210127_processed_final_text.csv")
metadata <- metadata %>%
  filter(str_detect(processed_text_bert, "obese|obesity"))

feature_matrix_2000 <- read.csv("211014_feature_matrix_2000.csv")
feature_matrix_full <- fread("211014_features_and_final_labels.csv")
feature_matrix_mismatch <- read.csv("211014_mismatched_data.csv")
#feature_matrix_200 <- read.csv("feature_matrix_200.csv")
```

# Significant Differences in Mismatched Data -- 2,000 Labeled Data
```{r}
feature_matrix_no_mismatch <- anti_join(feature_matrix_2000,
                                        feature_matrix_mismatch,
                                        by = "X")
which(!(colnames(feature_matrix_mismatch) %in% colnames(feature_matrix_no_mismatch)))
colnames(feature_matrix_mismatch)[c(2, 886, 896, 897)]

feature_matrix_no_mismatch %<>%
  filter(final_label != "") %>%
  mutate(final_label_numeric = case_when(
    final_label == "O" ~ 4,
    final_label == "F" ~ 0,
    final_label == "M" ~ 1,
    final_label == "S" ~ 2,
    final_label == "P" ~ 3),
    predicted_label = final_label_numeric)

feature_matrix_mismatch %<>%
  select(-level_0, -Unnamed..0.1)

which(!(colnames(feature_matrix_no_mismatch) %in% colnames(feature_matrix_mismatch)))
colnames(feature_matrix_no_mismatch)[c(18, 23, 792, 793, 889)]

feature_matrix_no_mismatch %<>%
  select(-index.1, -index.2, -index.3, -A, -Unnamed..0)

feature_matrix_mismatch_no_mismatch_combo <- rbind(feature_matrix_mismatch,
                                                   feature_matrix_no_mismatch)

feature_matrix_mismatch_no_mismatch_combo %<>%
  mutate(mismatch = case_when(
    final_label_numeric == predicted_label ~ "no mismatch",
    final_label_numeric != predicted_label ~ "mismatch"))

tfidf_sentiment_liwc <- colnames(feature_matrix_mismatch_no_mismatch_combo)[c(3:21, 791:883)]

feature_matrix_mismatch_comparison <- NULL
for (d in tfidf_sentiment_liwc) {
  comparison_loop <- feature_matrix_mismatch_no_mismatch_combo %>%
          ungroup() %>%
          group_by(mismatch) %>%
          summarise(d = d,
                    median = median(get(d), 
                                    na.rm = TRUE),
                    quantile_25 = quantile(get(d), 
                                           probs = 0.25,
                                           na.rm = TRUE),
                    quantile_75 = quantile(get(d), 
                                           probs = 0.75,
                                           na.rm = TRUE))
  feature_matrix_mismatch_comparison <- rbind(feature_matrix_mismatch_comparison, comparison_loop)
}

w_test_all_p_values <- c()
for (i in c(3:21, 791:883)) {
  print(colnames(feature_matrix_mismatch_no_mismatch_combo)[i])
  w_test_p_value_loop <- rep(wilcox.test(feature_matrix_mismatch[,i],
                            feature_matrix_no_mismatch[,i])$p.value, 2)
  w_test_all_p_values <- c(w_test_all_p_values, w_test_p_value_loop)
  print("**********")
}

feature_matrix_mismatch_comparison %<>%
  as.data.frame(.)

feature_matrix_mismatch_comparison$p_values <- w_test_all_p_values
feature_matrix_mismatch_comparison$bh_p_value <- p.adjust(feature_matrix_mismatch_comparison$p_values, method = "BH")
```

# Significant Differences, Label vs. No Label -- 2,000 Labeled Data
```{r}
feature_matrix_2000 %<>%
  mutate(final_label_binary = case_when(
    final_label == "" ~ "N",
    final_label != "" ~ "Y"
  ))

feature_matrix_comparison_binary <- NULL
for (d in tfidf_sentiment_liwc) {
  comparison_loop <- feature_matrix_2000 %>%
          ungroup() %>%
          group_by(final_label_binary) %>%
          summarise(d = d,
                    median = median(get(d), 
                                    na.rm = TRUE),
                    quantile_25 = quantile(get(d), 
                                           probs = 0.25,
                                           na.rm = TRUE),
                    quantile_75 = quantile(get(d), 
                                           probs = 0.75,
                                           na.rm = TRUE))
  feature_matrix_comparison_binary <- rbind(feature_matrix_comparison_binary, comparison_loop)
}

feature_matrix_2000_no_label <- feature_matrix_2000 %>%
  filter(final_label_binary == "N")

feature_matrix_2000_label <- feature_matrix_2000 %>%
  filter(final_label_binary == "Y")

w_test_all_p_values <- c()
for (i in c(3:17, 19:22, 795:887)) {
  print(colnames(feature_matrix_2000)[i])
  w_test_p_value_loop <- rep(wilcox.test(feature_matrix_2000_no_label[,i],
                            feature_matrix_2000_label[,i])$p.value, 2)
  w_test_all_p_values <- c(w_test_all_p_values, w_test_p_value_loop)
  print("**********")
}

feature_matrix_comparison_binary %<>%
  as.data.frame(.)

feature_matrix_comparison_binary$p_values <- w_test_all_p_values
feature_matrix_comparison_binary$bh_p_value <- p.adjust(feature_matrix_comparison_binary$p_values, method = "BH")

View(feature_matrix_comparison_binary %>% select(final_label_binary, d, median, quantile_25, quantile_75, bh_p_value))
```

# Plot of Type by Label Category - Full Data
```{r}
feature_matrix_full %<>%
  mutate(word_label = case_when(
    `0` == 0 ~ "Fact",
    `0` == 1 ~ "Misinformation",
    `0` == 2 ~ "Stigma",
    `0` == 3 ~ "Positivity",
    `0` == 4 ~ "Other"
  ))

feature_matrix_full %>%
  group_by(word_label) %>%
  summarise(count = n(),
            percent = n()/nrow(feature_matrix_full)*100) %>%
  ggplot(aes(x = reorder(word_label, - count), 
             y = count,
             fill = word_label)) +
  geom_bar(stat = "identity", 
           color = "black") +
  geom_text(aes(label=paste0(round(percent, 1), "%")), 
            position=position_dodge(width=0.9), 
            vjust=-0.25) +
  theme_classic() +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_lancet() + 
  labs(x = "Category",
       y = "Number of Comments",
       fill = "Category",
       title = "Distribution of Labeled Posts by Category")
setwd("~/Documents/Dartmouth/Research/Social Media/Figures")
ggsave("211014_final_label_distribution.tiff", width = 7.25, height = 4.51)

feature_matrix_full %>%
  filter(word_label != "Other") %>%
  group_by(word_label) %>%
  summarise(count = n(),
            percent = n()/nrow(feature_matrix_full)*100) %>%
  ggplot(aes(x = reorder(word_label, - count), 
             y = count,
             fill = word_label)) +
  geom_bar(stat = "identity", 
           color = "black") +
  geom_text(aes(label=paste0(round(percent, 1), "%")), 
            position=position_dodge(width=0.9), 
            vjust=-0.25) +
  theme_classic() +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_lancet() + 
  labs(x = "Category",
       y = "Number of Comments",
       fill = "Category",
       title = "Distribution of Non-Other Labeled Posts by Category")
setwd("~/Documents/Dartmouth/Research/Social Media/Figures")
ggsave("211014_final_label_distribution_noother.tiff", width = 7.25, height = 4.51)

```

# Comparison with LIWC2015
```{r}
feature_matrix_comparison_full <- NULL
tfidf_sentiment_liwc_spaces <- sapply(tfidf_sentiment_liwc, function(x) 
  {str_replace(x, "\\.", " ")})

tfidf_sentiment_liwc_spaces_new <- c()
for (a in tfidf_sentiment_liwc_spaces) {
  if (a == "function ") {
    tfidf_sentiment_liwc_spaces_new <- c(tfidf_sentiment_liwc_spaces_new, "function")
  } else {
    tfidf_sentiment_liwc_spaces_new <- c(tfidf_sentiment_liwc_spaces_new, a)
  }
}

tfidf_sentiment_liwc_spaces_full <- tfidf_sentiment_liwc_spaces_new[tfidf_sentiment_liwc_spaces_new %in% colnames(feature_matrix_full)]

for (d in tfidf_sentiment_liwc_spaces_full) {
  comparison_loop <- feature_matrix_full %>%
          ungroup() %>%
          filter(word_label != "Other") %>%
          group_by(word_label) %>%
          summarise(d = d,
                    mean_d = mean(get(d), na.rm = TRUE),
                    sd_d = sd(get(d), na.rm = TRUE))
  feature_matrix_comparison_full <- rbind(feature_matrix_comparison_full, comparison_loop)
}

feature_matrix_comparison_liwconly <- feature_matrix_comparison_full %>%
  filter(!(d %in% c("neg", "neu", "pos", "compound", "become obese", "com url", "lose weight", "morbid obesity", "morbidly obese", "obese people", "obese person", "obese woman", "obesity epidemic", "overweight obese", "obese women")))

nytimes_means <- c(744.62, 92.57, 68.17, 24.84, 43.61, 21.94, 23.58, 74.62, 42.39, 7.41, 3.56, 0.63, 0.38, 0.34, 1.53, 0.68, 3.84, 9.08, 14.27, 5.11, 2.76, 4.85, 0.62, 10.23, 4.52, 2.39, 1.26, 3.55, 1.94, 3.82, 2.32, 1.45, 0.25, 0.47, 0.29, 7.62, 0.33, 0.18, 0.62, 1.38, 7.52, 1.54, 1.42, 0.89, 1.74, 0.76, 2.03, 2.42, 0.88, 1.06, 0.35, 1.44, 0.41, 0.57, 0.10, 0.41, 7.60, 1.69, 1.82, 3.62, 1.07, 0.56, 4.09, 5.14, 0.8, 14.47, 1.70, 7.76, 5.17, 4.49, 1.67, 0.47, 1.47, 0.25, 0.22, 0.29, 0.02, 0.16, 0.05, 0.07, 0, 19.02, 5.88, 6.60, 0.27, 0.17, 0.15, 0.02, 1.23, 2.23, 1.56, 0.54, 0.36)

liwc2015 <- c(11921.82, 56.34, 57.95, 49.17, 54.22, 17.40, 15.60, 85.18, 51.87, 15.22, 9.95, 4.99, 0.72, 1.70, 1.88, 0.66, 5.26, 6.51, 12.93, 8.53, 5.27, 5.90, 1.66, 16.44, 4.49, 2.23, 1.61, 2.12, 2.02, 5.57, 3.67, 1.84, 0.31, 0.54, 0.41, 9.74, 0.44, 0.36, 0.98, 1.65, 10.61, 2.16, 1.40, 1.44, 2.52, 1.35, 2.99, 2.70, 1.08, 0.83, 0.64, 2.03, 0.69, 0.59, 0.13, 0.57, 6.93, 2.05, 1.30, 2.35, 1.46, 0.47, 4.64, 9.96, 1.42, 14.26, 2.15, 6.89, 5.46, 2.56, 1.35, 0.55, 0.68, 0.28, 0.16, 2.52, 0.21, 0.97, 0.95, 0.54, 0.11, 21.35, 7.49, 4.75, 0.64, 0.30, 0.58, 1, 1.19, 1.67, 2.46, 0.53, 0.73)

feature_matrix_comparison_liwconly <- cbind(feature_matrix_comparison_liwconly, 
                                            rep(liwc2015, 
                                                each = 4))

feature_matrix_comparison_liwconly <- feature_matrix_full %>%
  group_by(word_label) %>%
  summarise(n_per_label = n()) %>%
  right_join(feature_matrix_comparison_liwconly)

feature_matrix_comparison_liwconly %<>%
  rename("liwc_mean" = "rep(liwc2015, each = 4)")

feature_matrix_comparison_liwconly$liwc_pvalue <- NA
feature_matrix_comparison_liwconly$cohens_d <- NA

for (i in 1:nrow(feature_matrix_comparison_liwconly)) {
  feature_matrix_comparison_liwconly$liwc_pvalue[i] <- tsum.test(mean.x = feature_matrix_comparison_liwconly$mean_d[i], 
                                                                s.x = feature_matrix_comparison_liwconly$sd_d[i], 
                                                                n.x = feature_matrix_comparison_liwconly$n_per_label[i], 
                                                                mu = feature_matrix_comparison_liwconly$liwc_mean[i])$p.value
  feature_matrix_comparison_liwconly$cohens_d[i] <- abs((feature_matrix_comparison_liwconly$mean_d[i] - feature_matrix_comparison_liwconly$liwc_mean[i]) / feature_matrix_comparison_liwconly$sd_d[i])
}

feature_matrix_comparison_liwconly %<>%
  mutate(cohens_d_interpretation = case_when(
    cohens_d < 0.2 ~ "Negligible-to-Small Effect Size",
    cohens_d >= 0.2 & cohens_d < 0.5 ~ "Small-to-Medium Effect Size",
    cohens_d >= 0.5 & cohens_d < 0.8 ~ "Medium-to-Large Effect Size",
     cohens_d >= 0.8 ~ "Large Effect Size"
  ))

feature_matrix_comparison_liwconly$p_adjust <- p.adjust(feature_matrix_comparison_liwconly$liwc_pvalue,
                                                        method = "BH")

View(feature_matrix_comparison_liwconly %>%
       arrange(desc(cohens_d)))

View(feature_matrix_comparison_liwconly %>%
       select(word_label,
              d,
              mean_d,
              sd_d,
              cohens_d) %>%
       mutate(cohens_d = round(cohens_d, 2),
              mean_d = round(mean_d, 2),
              sd_d = round(sd_d, 2)))
```

## Visualization
```{r}
feature_matrix_comparison_liwconly_large_effect <- feature_matrix_comparison_liwconly %>%
  filter(cohens_d > 0.80)

feature_matrix_comparison_liwconly %>%
  filter(d %in% feature_matrix_comparison_liwconly_large_effect$d &
           d != "WC") %>%
  group_by(d) %>%
  filter(d %in% c("Colon", "friend", "Tone", "relativ", "Clout", "QMark", "social", "WPS", "Authentic")) %>%
  mutate(label_plot = case_when(
           d == "friend" ~ "Friends",
           d == "relativ" ~ "Relativity",
           d == "QMark" ~ "Question Marks",
           d == "WPS" ~ "Words per Sentence",
           TRUE ~ str_to_sentence(d)),
         fill_plot = case_when(
           d %in% c("Colon", "friend", "Tone") & word_label == "Misinformation" ~ "0",
           d %in% c("relativ") & word_label == "Stigma" ~ "1",
           d %in% c("Clout", "QMark", "social", "WPS", "Authentic") & word_label == "Positivity" ~ "2",
           TRUE ~ "3"),
         label_plot = factor(label_plot,
                             levels = c("Colon", "Friends", "Tone", "Relativity", "Clout", "Question Marks", "Social", "Words per Sentence", "Authentic")),
         word_label = factor(word_label,
                             levels = c("Positivity",
                                        "Stigma",
                                        "Misinformation",
                                        "Fact"))) %>%
  ggplot(aes(y = word_label,
             x = mean_d,
             fill = fill_plot)) +
  geom_bar(stat = "identity",
           color = "black") +
  geom_errorbar(aes(xmin = mean_d - sd_d,
                    xmax = mean_d + sd_d),
                width = 0.2,
                position = position_dodge(0.90)) + 
  facet_wrap(~label_plot,
             scales = "free_x") +
  geom_vline(mapping = aes(xintercept = liwc_mean),
             linetype = "dashed") + 
  scale_fill_manual(values = c("#4E79A7",
                                "#F28E2B",
                                "#FFBE7D",
                                "grey88")) + 
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "Count, Percent, or Standardized Score",
       y = "Label Category",
       title = "Comparisons Between Select LIWC Psycholinguistic Features\nand Label Categories")
setwd("~/Documents/dartmouth/research/aim2_reddit_misinformation_stigma/figures")
ggsave("220111_liwc_cohensd.tiff", width = 7.25, height = 4.51)

```

# Two-Part Model for Semicontinuous Data
## Part 1a: Zero-inflated M/F
```{r}
feature_matrix_twopartmodel <- feature_matrix_full %>%
  select(all_of(tfidf_sentiment_liwc_spaces_full), word_label)

feature_matrix_twopartmodel_fm <- feature_matrix_twopartmodel %>%
  filter(word_label %in% c("Fact", "Misinformation"))

feature_matrix_twopartmodel_ps <- feature_matrix_twopartmodel %>%
  filter(word_label %in% c("Positivity", "Stigma"))

zero_model_fm <- NULL
nonzero_model_fm <- NULL
for (val in tfidf_sentiment_liwc_spaces_full) {
  loop <- feature_matrix_twopartmodel_fm %>%
    select(val, word_label) #Extracting just the label and the term of interest
  
  if (min(loop[,1] > 0)) { #Checking that at least one 0 in the data
    next 
  }
  loop$val_binary <- ifelse(loop[,1] > 0, 1, 0) #Binary yes/no for zeros
  loop_tidy <- glm(val_binary ~ word_label,
                   data = loop,
                   family = binomial(link = "logit")) %>%
    tidy(conf.int = TRUE,
         exponentiate = TRUE) %>%
    select(term, estimate, conf.low, conf.high, p.value) #Zero-inflated model
  
  loop_tidy$val <- val
  zero_model_fm <- rbind(zero_model_fm, loop_tidy) #Adding results to final DF
      
  loop_part2 <- loop %>%
    filter(val_binary == 1) #Only keeping non-zero values

  if (length(unique(loop_part2$word_label)) == 1) { #Checking that both types of labels are in the filtered data set
    next
  }
  loop_tidy_part2 <- lm(get(val) ~ word_label,
                   data = loop_part2) %>%
    tidy(conf.int = TRUE) %>%
    select(term, estimate, conf.low, conf.high, p.value)
  
  loop_tidy_part2$val <- val
  nonzero_model_fm <- rbind(nonzero_model_fm, loop_tidy_part2)   
}

zero_model_fm %<>%
  filter(term != "(Intercept)")

zero_model_fm$p_value_adjusted <- p.adjust(zero_model_fm$p.value, 
                                           method = "BH")

nonzero_model_fm %<>%
  filter(term != "(Intercept)")

nonzero_model_fm$p_value_adjusted <- p.adjust(nonzero_model_fm$p.value, 
                                           method = "BH")

View(nonzero_model_fm %>%
  filter(term != "(Intercept)") %>%
  mutate(estimate = round(estimate, 3),
         conf.low = round(conf.low, 3),
         conf.high = round(conf.high, 3),
         p_value_adjusted = round(p_value_adjusted, 3)) %>%
  select(val, estimate, conf.low, conf.high, p_value_adjusted))
```

## Part 2b: Visualization
```{r}
top_ten_fm <- zero_model_fm %>%
  filter(is.na(conf.low) == FALSE &
           is.na(conf.high) == FALSE) %>%
  mutate(facet = case_when(
    p_value_adjusted >= 0.05 ~ "Not Significant",
    p_value_adjusted < 0.05 & estimate > 1 ~ "Misinformation > Fact",
    p_value_adjusted < 0.05 & estimate < 1 ~ "Misinformation < Fact"
  )) %>%
  arrange(desc(estimate)) %>%
  group_by(facet) %>%
  slice_max(estimate, n = 10, with_ties = T) %>%
  filter(facet == "Misinformation > Fact") %>%
  mutate(estimate_order = estimate)
  

bottom_ten_fm <- zero_model_fm %>%
  filter(is.na(conf.low) == FALSE &
           is.na(conf.high) == FALSE) %>%
  mutate(facet = case_when(
    p_value_adjusted >= 0.05 ~ "Not Significant",
    p_value_adjusted < 0.05 & estimate > 1 ~ "Misinformation > Fact",
    p_value_adjusted < 0.05 & estimate < 1 ~ "Misinformation < Fact"
  )) %>%
  group_by(facet) %>%
  slice_min(estimate, n = 10, with_ties = T) %>%
  filter(facet == "Misinformation < Fact") %>%
  arrange(estimate)

bottom_ten$estimate_order <- as.numeric(rep(nrow(bottom_ten):1))

top_ten %>%
  rbind(bottom_ten) %>%
  mutate(val_plot = case_when(
    val == "death" ~ "Personal Concerns - Death",
    val == "focuspresent" ~ "Time Orientation - Present Focus",
    val == "swear" ~ "Swear Words",
    val == "Exclam" ~ "Exclamation Points",
    val == "we" ~ "First Person Plural Pronouns",
    val == "verb" ~ "Reglar Verbs",
    val == "anger" ~ "Affect Words - Anger",
    val == "Apostro" ~ "Apostrophes",
    val == "negate" ~ "Negations",
    val == "Parenth" ~ "Parenthses (Pairs)",
    val == "Colon" ~ "Colons",
    val == "netspeak" ~ "Net Speak",
    val == "OtherP" ~ "Other Punctuation",
    val == "Dash" ~ "Dashes",
    val == "friend" ~ "Social Words - Friends",
    val == "sexual" ~ "Biological Processes - Sexuality",
    TRUE ~ val)) %>%
  filter(facet != "Not Significant") %>%
  ggplot(aes(x = estimate, 
             y = reorder(val_plot, estimate_order),
             color = facet)) + 
  geom_point() +
  geom_errorbar(aes(xmin=conf.low, 
                    xmax=conf.high), 
                width=.2) +
  scale_color_npg() + 
  facet_wrap(~facet, 
             scales = "free") + 
  labs(x = "Odds Ratio",
       y = "Psycholinguistic Category",
       title = "Odds of Non-Zero Value, Fact vs. Misinformation") +
  theme_classic() +
  theme(strip.text = element_text(size = 7),
        legend.position = "bottom",
        legend.title = element_blank())
setwd("~/Documents/Dartmouth/Research/Social Media/Figures")
ggsave("211018_odds_of_nonzero_fm.tiff", width = 7.25, height = 4.51)

nonzero_model_fm %>%
  filter(is.na(conf.high) == FALSE &
           is.na(conf.low) == FALSE) %>%
  mutate(facet = case_when(
    p_value_adjusted >= 0.05 ~ "Not Significant",
    p_value_adjusted < 0.05 & estimate > 0 ~ "Misinformation > Fact",
    p_value_adjusted < 0.05 & estimate < 0 ~ "Misinformation < Fact"
  )) %>%
  filter(p_value_adjusted < 0.05) %>%
  mutate(val_plot = case_when(
    val == "AllPunc" ~ "All Punctuation",
    val == "Sixltr" ~ "Words with At Least Six Letters",
    val == "compound" ~ "Compound Sentiment Score",
    val == "friend" ~ "Social Words - Friends",
    val == "Apostro" ~ "Apostrophes",
    val == "home" ~ "Personal Concerns - Home",
    val == "negate" ~ "Negations",
    val == "death" ~ "Personal Concerns - Death",
    val == "focuspresent" ~ "Time Orientation - Present Focus",
    val == "shehe" ~ "Third Person Singular Pronouns",
    val == "Exclam" ~ "Exclamation Points",
    val == "netspeak" ~ "Net Speak",
    val == "Quote" ~ "Quotation Marks"
  )) %>%
  arrange(desc(estimate)) %>%
  group_by(facet) %>%
  mutate(absolute_estimate = abs(estimate)) %>%
  slice_max(absolute_estimate, n = 10, with_ties = T) %>%
  ggplot(aes(x = estimate, 
             y = reorder(val_plot, -estimate),
             color = facet)) + 
  geom_errorbar(aes(xmin=conf.low, 
                    xmax=conf.high), 
                width=0.2) +
  geom_point() +
  geom_vline(xintercept = 0,
             linetype = "dashed") + 
    scale_color_manual(values = c("#A0CBE8", #Fact
                                  "#4E79A7" #Misinformation
                                #"#F28E2B", #Stigma
                                #FFBE7D", #Positivity
                                #"#BAB0AC"
                                )) + 
  #facet_wrap(~facet,
  #           scales = "free") + 
  labs(x = expression(beta),
       y = "Psycholinguistic Features",
       title = "Association Between Psycholinguistic Features and Label:\nFact vs. Misinformation, Top 10") +
  theme_classic() +
  theme(strip.text = element_text(size = 7),
        legend.position = "bottom",
        legend.title = element_blank())
setwd("~/Documents/dartmouth/research/aim2_reddit_misinformation_stigma/figures")
ggsave("220111_nonzero_regression_fm_nofacet.tiff", width = 7.25, height = 4.51)

```

## Part 2a: Zero-inflated S/P
```{r}
zero_model_ps <- NULL
nonzero_model_ps <- NULL
for (val in tfidf_sentiment_liwc_spaces_full) {
  loop <- feature_matrix_twopartmodel_ps %>%
    select(val, word_label) #Extracting just the label and the term of interest
  
  if (min(loop[,1] > 0)) { #Checking that at least one 0 in the data
    next 
  }
  loop$val_binary <- ifelse(loop[,1] > 0, 1, 0) #Binary yes/no for zeros
  loop_tidy <- glm(val_binary ~ word_label,
                   data = loop,
                   family = binomial(link = "logit")) %>%
    tidy(conf.int = TRUE,
         exponentiate = TRUE) %>%
    select(term, estimate, conf.low, conf.high, p.value) #Zero-inflated model
  
  loop_tidy$val <- val
  zero_model_ps <- rbind(zero_model_ps, loop_tidy) #Adding results to final DF
      
  loop_part2 <- loop %>%
    filter(val_binary == 1) #Only keeping non-zero values

  if (length(unique(loop_part2$word_label)) == 1) { #Checking that both types of labels are in the filtered data set
    next
  }
  loop_tidy_part2 <- lm(get(val) ~ word_label,
                   data = loop_part2) %>%
    tidy(conf.int = TRUE) %>%
    select(term, estimate, conf.low, conf.high, p.value)
  
  loop_tidy_part2$val <- val
  nonzero_model_ps <- rbind(nonzero_model_ps, loop_tidy_part2)   
}

zero_model_ps %<>%
  filter(term != "(Intercept)")

zero_model_ps$p_value_adjusted <- p.adjust(zero_model_ps$p.value, 
                                           method = "BH")

View(zero_model_ps %>%
  mutate(estimate = round(estimate, 3),
         conf.low = round(conf.low, 3),
         conf.high = round(conf.high, 3),
         p_value_adjusted = round(p_value_adjusted, 3)) %>%
  select(val, estimate, conf.low, conf.high, p_value_adjusted) %>%
    filter(val != "function"))

nonzero_model_ps %<>%
  filter(term != "(Intercept)")

nonzero_model_ps$p_value_adjusted <- p.adjust(nonzero_model_ps$p.value, 
                                           method = "BH")

View(nonzero_model_ps %>%
  filter(term != "(Intercept)") %>%
  mutate(estimate = round(estimate, 3),
         conf.low = round(conf.low, 3),
         conf.high = round(conf.high, 3),
         p_value_adjusted = round(p_value_adjusted, 3)) %>%
  select(val, estimate, conf.low, conf.high, p_value_adjusted))


```

## Part 2b: Visualization
```{r}
top_ten <- zero_model_ps %>%
  filter(is.na(conf.low) == FALSE &
           is.na(conf.high) == FALSE) %>%
  mutate(facet = case_when(
    p_value_adjusted >= 0.05 ~ "Not Significant",
    p_value_adjusted < 0.05 & estimate > 1 ~ "Stigma > Positivity",
    p_value_adjusted < 0.05 & estimate < 1 ~ "Stigma < Positivity"
  )) %>%
  arrange(desc(estimate)) %>%
  group_by(facet) %>%
  slice_max(estimate, n = 10, with_ties = T) %>%
  filter(facet == "Stigma > Positivity") %>%
  mutate(estimate_order = estimate)

bottom_ten <- zero_model_ps %>%
  filter(is.na(conf.low) == FALSE &
           is.na(conf.high) == FALSE) %>%
  mutate(facet = case_when(
    p_value_adjusted >= 0.05 ~ "Not Significant",
    p_value_adjusted < 0.05 & estimate > 1 ~ "Stigma > Positivity",
    p_value_adjusted < 0.05 & estimate < 1 ~ "Stigma < Positivity"
  )) %>%
  group_by(facet) %>%
  slice_min(estimate, n = 10, with_ties = T) %>%
  filter(facet != "Stigma > Positivity") %>%
  arrange(estimate)

bottom_ten$estimate_order <- as.numeric(rep(nrow(bottom_ten):1))

top_ten %>%
  rbind(bottom_ten) %>%
  ggplot(aes(x = estimate, 
             y = reorder(val, estimate_order),
             color = facet)) + 
  geom_point() +
  geom_errorbar(aes(xmin=conf.low, 
                    xmax=conf.high), 
                width=.2) +
  scale_color_npg() + 
  facet_wrap(~facet, 
             scales = "free") + 
  labs(x = "Odds Ratio",
       y = "Psycholinguistic Category",
       title = "Odds of Non-Zero Value, Positivity vs. Stigma",
       color = "Positivity vs. Stigma") +
  theme_classic() +
  theme(strip.text = element_text(size = 7),
        legend.position = "bottom")
setwd("~/Documents/Dartmouth/Research/Social Media/Figures")
ggsave("211018_odds_of_nonzero_ps.tiff", width = 7.25, height = 4.51)

nonzero_model_ps %>%
  filter(is.na(conf.high) == FALSE &
           is.na(conf.low) == FALSE) %>%
  mutate(facet = case_when(
    p_value_adjusted >= 0.05 ~ "Not Significant",
    p_value_adjusted < 0.05 & estimate > 0 ~ "Stigma > Positivity",
    p_value_adjusted < 0.05 & estimate < 0 ~ "Stigma < Positivity"
  )) %>%
  arrange(desc(estimate)) %>%
  group_by(facet) %>%
  mutate(absolute_estimate = abs(estimate)) %>%
  slice_max(absolute_estimate, n = 10, with_ties = T) %>%
  ggplot(aes(x = estimate, 
             y = reorder(val, absolute_estimate),
             color = facet)) + 
  geom_point() +
  geom_errorbar(aes(xmin=conf.low, 
                    xmax=conf.high), 
                width=.2) +
  scale_color_npg() + 
  facet_wrap(~facet, 
             scales = "free") + 
  labs(x = expression(beta),
       y = "Psycholinguistic Category",
       title = "Association Between Characteristics and Label:\nPositivity vs. Stigma, Top 10") +
  theme_classic() +
  theme(strip.text = element_text(size = 7),
        legend.position = "bottom",
        legend.title = element_blank())
setwd("~/Documents/Dartmouth/Research/Social Media/Figures")
ggsave("211017_nonzero_regression_ps.tiff", width = 7.25, height = 4.51)

nonzero_model_ps %>%
  filter(is.na(conf.high) == FALSE &
           is.na(conf.low) == FALSE) %>%
  mutate(facet = case_when(
    p_value_adjusted >= 0.05 ~ "Not Significant",
    p_value_adjusted < 0.05 & estimate > 0 ~ "Stigma > Positivity",
    p_value_adjusted < 0.05 & estimate < 0 ~ "Stigma < Positivity"
  )) %>%
  filter(p_value_adjusted < 0.05) %>%
   mutate(val_plot = case_when(
     val == "AllPunc" ~ "All Punctuation",
     val == "Sixltr" ~ "Words with At Least Six Letters",
     val == "i" ~ "First Person Singular Pronouns",
     val == "relativ" ~ "Relativity",
     val == "function" ~ "Total Function Words",
     val == "time" ~ "Relativity - Time",
     val == "ppron" ~ "Personal Pronouns",
     val == "focuspast" ~ "Time Orientation - Past Focus",
     val == "verb" ~ "Common Verbs",
     val == "prep" ~ "Prepositions",
     val == "number" ~ "Numbers",
     val == "Sixltr" ~ "Words with At Least Six Letters",
     val == "social" ~ "Social Processes",
     val == "negemo" ~ "Negative Emotions",
     val == "anger" ~ "Negative Emotions - Anger",
     val == "they" ~ "Third Person Plural Pronouns",
     val == "swear" ~ "Swear Words",
     val == "affect" ~ "Affective Processes",
     val == "informal" ~ "Informal Language",
     val == "ipron" ~ "Impersonal Pronouns",
     val == "sexual" ~ "Biological Processes - Sexual",
   )) %>%
  arrange(desc(estimate)) %>%
  group_by(facet) %>%
  mutate(absolute_estimate = abs(estimate)) %>%
  slice_max(absolute_estimate, n = 10, with_ties = T) %>%
  ggplot(aes(x = estimate, 
             y = reorder(val_plot, -estimate),
             color = facet)) + 
  geom_errorbar(aes(xmin=conf.low, 
                    xmax=conf.high), 
                width=0.2) +
  geom_point() +
  scale_color_manual(values = c("#FFBE7D",
                                "#F28E2B")) + 
  geom_vline(xintercept = 0,
             linetype = "dashed") + 
  #facet_wrap(~facet,
  #           scales = "free") + 
  labs(x = expression(beta),
       y = "Psycholinguistic Features",
       title = "Association Between Psycholinguistic Features and Label:\nPositivity vs. Stigma, Top 10") +
  theme_classic() +
  theme(strip.text = element_text(size = 7),
        legend.position = "bottom",
        legend.title = element_blank())
setwd("~/Documents/dartmouth/research/aim2_reddit_misinformation_stigma/figures")
ggsave("220111_nonzero_regression_ps_nofacet.tiff", width = 7.25, height = 4.51)

```

# Exporting Models for Easy Copy-Paste
```{r}
write.csv(zero_model_fm, "211019_zero_model_fm.csv")
write.csv(nonzero_model_fm, "211019_nonzero_model_fm.csv")
write.csv(zero_model_ps, "211019_zero_model_ps.csv")
write.csv(nonzero_model_ps, "211019_nonzero_model_ps.csv")

```

# TSNE Visualization
```{r}
feature_matrix_tsne <- feature_matrix_full[, c(3:785, 788:880)] #764179
#colnames(feature_matrix_tsne)[colSums(is.na(feature_matrix_tsne)) > 0]
feature_matrix_tsne <- feature_matrix_tsne[complete.cases(feature_matrix_tsne), ] #764,178
feature_matrix_tsne %<>%
  distinct() #763,705 (lost 473)

tsne_data <- Rtsne(feature_matrix_tsne, 
                   dims = 2,
                   max_iter = 500,
                   verbose = TRUE,
                   partial_pca = TRUE)

feature_matrix_tsne_labels <- feature_matrix_full[, c(3:785, 788:880, 887)] #764179
#colnames(feature_matrix_tsne)[colSums(is.na(feature_matrix_tsne)) > 0]
feature_matrix_tsne_labels <- feature_matrix_tsne_labels[complete.cases(feature_matrix_tsne_labels), ] #764,178
feature_matrix_tsne_labels %<>%
  distinct() #763,705 (lost 473)

tsne_dataframe <- as.data.frame(tsne_data$Y)
tsne_dataframe$word_label <- feature_matrix_tsne_labels$word_label

tsne_dataframe %>%
  #filter(row_number() <= 100000) %>%
  filter(word_label != "Other") %>%
  ggplot(aes(x = V1,
             y = V2,
             color = word_label)) +
  #facet_wrap(~word_label) + 
  #geom_jitter(size = 0.0000000001) +
  geom_point(size = 0.025) +
  theme_classic() +
  labs(x = "Dimension 1",
         y = "Dimension 2",
         title = "TSNE Visualization of Labeled Data",
         color = "Label") +
  scale_color_jama() +
  guides(color = guide_legend(override.aes = list(size=2.5)))
setwd("~/Documents/dartmouth/research/aim2_reddit_misinformation_stigma/figures")
ggsave("211209_tsne_noother.tiff", width = 7.25, height = 4.51)

tsne_dataframe %>%
  mutate(word_alpha = case_when(
    word_label == "Other" ~ 0.001,
    word_label == "Misinformation" ~ 1,
    word_label == "Fact" ~ 1,
    word_label == "Positivity" ~ 1,
    word_label == "Stigma" ~ 1),
    word_label_plot = factor(word_label,
                             levels = c("Misinformation", "Stigma", "Fact", "Positivity", "Other"))) %>%
  ggplot(aes(x = V1,
             y = V2,
             color = word_label_plot,
             alpha = word_alpha,
             size = word_label_plot)) +
  geom_jitter() +
  theme_classic() +
  labs(x = "Dimension 1",
         y = "Dimension 2",
         title = "TSNE Visualization of Labeled Data",
         color = "Label") +
  scale_color_manual(values = c("#4E79A7",
                                "#F28E2B",
                                "#A0CBE8",
                                "#FFBE7D",
                                "#BAB0AC")) + 
  scale_size_manual(values = c(1, 1, 0.5, 0.5, 0.5),
                    guide = "none") +
  scale_alpha(guide = "none") 
setwd("~/Documents/dartmouth/research/aim2_reddit_misinformation_stigma/figures")
ggsave("211209_tsne_full.tiff", width = 7.25, height = 4.51)
```

## Multipane TSNE Plot
```{r}
a <- tsne_dataframe %>%
  mutate(word_label_plot = case_when(
    word_label == "Fact" ~ "Fact",
    word_label != "Fact" ~ "Not Fact"),
    word_alpha = case_when(
      word_label == "Fact" ~ 1,
      word_label != "Fact" ~ 0.001
    )) %>%
  ggplot(aes(x = V1,
             y = V2,
             color = word_label_plot,
             alpha = word_alpha,
             size = word_label_plot)) +
  geom_jitter() +
  theme_classic() +
  labs(x = "Dimension 1",
         y = "Dimension 2",
         title = "Fact",
         color = "Label") +
  scale_color_manual(values = c(#"#4E79A7", #Misinformation
                                #"#F28E2B", #Stigma
                                "#A0CBE8", #Fact
                                #"#FFBE7D", #Positivity
                                "#BAB0AC"),
                     guide = "none") + 
  scale_size_manual(values = c(1, 0.00005),
                    guide = "none") +
  scale_alpha(guide = "none") 

b <- tsne_dataframe %>%
  mutate(word_label_plot = case_when(
    word_label == "Misinformation" ~ "Misinformation",
    word_label != "Misinformation" ~ "Not Misinformation"),
    word_alpha = case_when(
      word_label == "Misinformation" ~ 1,
      word_label != "Misinformation" ~ 0.001
    )) %>%
  ggplot(aes(x = V1,
             y = V2,
             color = word_label_plot,
             alpha = word_alpha,
             size = word_label_plot)) +
  geom_jitter() +
  theme_classic() +
  labs(x = "Dimension 1",
         y = "Dimension 2",
         title = "Misinformation",
         color = "Label") +
  scale_color_manual(values = c("#4E79A7", #Misinformation
                                #"#F28E2B", #Stigma
                                #"#A0CBE8", #Fact
                                #"#FFBE7D", #Positivity
                                "#BAB0AC"),
                     guide = "none") + 
  scale_size_manual(values = c(1, 0.00005),
                    guide = "none") +
  scale_alpha(guide = "none") 

c <- tsne_dataframe %>%
  mutate(word_label_plot = case_when(
    word_label == "Positivity" ~ "Positivity",
    word_label != "Positivity" ~ "X Positivity"),
    word_alpha = case_when(
      word_label == "Positivity" ~ 1,
      word_label != "Positivity" ~ 0.001
    )) %>%
  ggplot(aes(x = V1,
             y = V2,
             color = word_label_plot,
             alpha = word_alpha,
             size = word_label_plot)) +
  geom_jitter() +
  theme_classic() +
  labs(x = "Dimension 1",
         y = "Dimension 2",
         title = "Positivity",
         color = "Label") +
  scale_color_manual(values = c(#"#4E79A7", #Misinformation
                                #"#F28E2B", #Stigma
                                #"#A0CBE8", #Fact
                                "#FFBE7D", #Positivity
                                "#BAB0AC"),
                     guide = "none") + 
  scale_size_manual(values = c(1, 0.00005),
                    guide = "none") +
  scale_alpha(guide = "none") 

d <- tsne_dataframe %>%
  mutate(word_label_plot = case_when(
    word_label == "Stigma" ~ "Stigma",
    word_label != "Stigma" ~ "X Stigma"),
    word_alpha = case_when(
      word_label == "Stigma" ~ 1,
      word_label != "Stigma" ~ 0.001
    )) %>%
  ggplot(aes(x = V1,
             y = V2,
             color = word_label_plot,
             alpha = word_alpha,
             size = word_label_plot)) +
  geom_jitter() +
  theme_classic() +
  labs(x = "Dimension 1",
         y = "Dimension 2",
         title = "Stigma",
         color = "Label") +
  scale_color_manual(values = c(#"#4E79A7", #Misinformation
                                "#F28E2B", #Stigma
                                #"#A0CBE8", #Fact
                                #"#FFBE7D", #Positivity
                                "#BAB0AC"),
                     guide = "none") + 
  scale_size_manual(values = c(1, 0.00005),
                    guide = "none") +
  scale_alpha(guide = "none") 

e <- tsne_dataframe %>%
  mutate(word_label_plot = case_when(
    word_label == "Other" ~ "Other",
    word_label != "Other" ~ "X Other"),
    word_alpha = case_when(
      word_label == "Other" ~ 1,
      word_label != "Other" ~ 0.001
    )) %>%
  ggplot(aes(x = V1,
             y = V2,
             color = word_label_plot,
             alpha = word_alpha,
             size = word_label_plot)) +
  geom_jitter() +
  theme_classic() +
  labs(x = "Dimension 1",
         y = "Dimension 2",
         title = "Other",
         color = "Label") +
  scale_color_manual(values = c(#"#4E79A7", #Misinformation
                                #"#F28E2B", #Stigma
                                #"#A0CBE8", #Fact
                                #"#FFBE7D", #Positivity
                                "#B07AA1", #Other
                                "#BAB0AC"),
                     guide = "none") + 
  scale_size_manual(values = c(1, 0.00005),
                    guide = "none") +
  scale_alpha(guide = "none") 

ggarrange(a, b, c, d, e, nrow = 3, ncol = 2)
setwd("~/Documents/dartmouth/research/aim2_reddit_misinformation_stigma/figures")
ggsave("211210_tsne_full_split.tiff", width = 7.25, height = 7.25)
```

# Updated TSNE Visualization
- Remove Other
- Randomly Sample Points from Each Category (up to 100)
```{r}
feature_matrix_tsne_labels <- feature_matrix_full[, c(3:785, 788:880, 887)] #764179
feature_matrix_tsne_labels <- feature_matrix_tsne_labels[complete.cases(feature_matrix_tsne_labels), ] #764,178
feature_matrix_tsne_labels %<>%
  distinct() #763,705 (lost 473)

set.seed(110295)
feature_matrix_tsne_labels_sampled <- feature_matrix_tsne_labels %>%
  filter(word_label != "Other") %>%
  group_by(word_label) %>%
  sample_n(1000)

feature_matrix_tsne_sampled <- feature_matrix_tsne_labels_sampled %>%
  select(-word_label)

tsne_data_sampled <- Rtsne(feature_matrix_tsne_sampled, 
                   dims = 2,
                   max_iter = 500,
                   verbose = TRUE,
                   partial_pca = TRUE)

tsne_dataframe_sampled <- as.data.frame(tsne_data_sampled$Y)
tsne_dataframe_sampled$word_label <- feature_matrix_tsne_labels_sampled$word_label

tsne_dataframe_sampled %>%
  ggplot(aes(x = V1,
             y = V2,
             color = word_label)) +
  #facet_wrap(~word_label) + 
  #geom_jitter(size = 0.0000000001) +
  geom_point() +
  theme_classic() +
  labs(x = "Dimension 1",
         y = "Dimension 2",
         title = "TSNE Visualization of Sampled Labeled Data",
         color = "Label") +
  scale_color_jama() +
  guides(color = guide_legend(override.aes = list(size=2.5)))
setwd("~/Documents/dartmouth/research/aim2_reddit_misinformation_stigma/figures")
ggsave("211213_tsne_noother_sampled.tiff", width = 7.25, height = 4.51)
```

# Updated TSNE Visualization - Split Categories out
##Misinformation vs. Fact
```{r}
feature_matrix_tsne_labels_sampled_mf <- feature_matrix_tsne_labels_sampled %>%
  filter(word_label %in% c("Misinformation", "Fact"))

feature_matrix_tsne_sampled_mf <- feature_matrix_tsne_labels_sampled_mf %>%
  select(-word_label)

tsne_data_sampled_mf <- Rtsne(feature_matrix_tsne_sampled_mf, 
                   dims = 2,
                   max_iter = 500,
                   verbose = TRUE,
                   partial_pca = TRUE)

tsne_dataframe_sampled_mf <- as.data.frame(tsne_data_sampled_mf$Y)
tsne_dataframe_sampled_mf$word_label <- feature_matrix_tsne_labels_sampled_mf$word_label

a<- tsne_dataframe_sampled_mf %>%
  mutate(word_label_plot = factor(word_label, 
                                  levels = c("Misinformation", "Fact"))) %>%
  ggplot(aes(x = V1,
             y = V2,
             color = word_label_plot)) +
  #facet_wrap(~word_label) + 
  #geom_jitter(size = 0.0000000001) +
  geom_point() +
  theme_classic() +
  labs(x = "Dimension 1",
         y = "Dimension 2",
         title = "TSNE Visualization of Sampled Labeled Data\nFact vs. Misinformation",
         color = "Label") +
  scale_color_manual(values = c("#4E79A7", #Misinformation
                                #"#F28E2B", #Stigma
                                "#A0CBE8" #Fact
                                #"#FFBE7D", #Positivity
                                #"#B07AA1", #Other
  ))
setwd("~/Documents/dartmouth/research/aim2_reddit_misinformation_stigma/figures")
ggsave("211217_tsne_noother_sampled_mf_1000.tiff", width = 7.25, height = 4.51)
```

##Stigma vs. Positivity
```{r}
feature_matrix_tsne_labels_sampled_sp <- feature_matrix_tsne_labels_sampled %>%
  filter(word_label %in% c("Stigma", "Positivity"))

feature_matrix_tsne_sampled_sp <- feature_matrix_tsne_labels_sampled_sp %>%
  select(-word_label)

tsne_data_sampled_sp <- Rtsne(feature_matrix_tsne_sampled_sp, 
                   dims = 2,
                   max_iter = 500,
                   verbose = TRUE,
                   partial_pca = TRUE)

tsne_dataframe_sampled_sp <- as.data.frame(tsne_data_sampled_sp$Y)
tsne_dataframe_sampled_sp$word_label <- feature_matrix_tsne_labels_sampled_sp$word_label

b <- tsne_dataframe_sampled_sp %>%
  mutate(word_label_plot = factor(word_label,
                                  levels = c("Stigma", "Positivity"))) %>%
  ggplot(aes(x = V1,
             y = V2,
             color = word_label)) +
  #facet_wrap(~word_label) + 
  #geom_jitter(size = 0.0000000001) +
  geom_point() +
  theme_classic() +
  labs(x = "Dimension 1",
         y = "Dimension 2",
         title = "TSNE Visualization of Sampled Labeled Data\nStigma vs. Positivity",
         color = "Label") +
  scale_color_manual(values = c(#"#4E79A7", #Misinformation
                                "#F28E2B", #Stigma
                                #"#A0CBE8" #Fact
                                "#FFBE7D" #Positivity
                                #"#B07AA1", #Other
  ))
setwd("~/Documents/dartmouth/research/aim2_reddit_misinformation_stigma/figures")
ggsave("211217_tsne_noother_sampled_sp_1000.tiff", width = 7.25, height = 4.51)
```

## Combine into one plot
```{r}
tsne_plot <- ggarrange(a + ylim(-35, 35) + ggtitle("Fact vs. Misinformation") + theme(legend.position = "bottom"),
                       b + ylim(-35, 35) + ggtitle("Stigma vs. Positivity") + theme(axis.text.y = element_blank(),
                                                                                    axis.ticks.y = element_blank(),
                                                                                    axis.title.y = element_blank(),
                                                                                    legend.position = "bottom"))
annotate_figure(tsne_plot, top = "TSNE Visualization of Sampled Labeled Data")
setwd("~/Documents/dartmouth/research/aim2_reddit_misinformation_stigma/figures")
ggsave("211220_tsne_noother_sampled_all_1000.tiff", width = 7.25, height = 4.51)

```

# Compare with Metadata
```{r}
feature_matrix_2000_with_metadata <- feature_matrix_2000 %>%
  left_join(metadata, c("B" = "body", "processed_text", "processed_text_bert", "tokens", "final_text")) %>%
  distinct()

metadata %>%
  group_by(subreddit) %>%
  summarise(count = n()) %>%
  arrange(desc(count))

feature_matrix_2000_with_metadata %>%
  group_by(subreddit) %>%
  summarise(count = n()) %>%
  arrange(desc(count))
```

# Other vs. Each Category
## Modeling
```{r}
feature_matrix_twopartmodel <- feature_matrix_full %>%
  select(all_of(tfidf_sentiment_liwc_spaces_full), word_label)

feature_matrix_twopartmodel$word_label <- factor(feature_matrix_twopartmodel$word_label, levels = c("Other", "Fact", "Misinformation", "Positivity", "Stigma"))

zero_model_all <- NULL
nonzero_model_all <- NULL
for (val in tfidf_sentiment_liwc_spaces_full) {
  print(val)
  loop <- feature_matrix_twopartmodel %>%
    select(val, word_label) #Extracting just the label and the term of interest
  
  if (min(loop[,1] > 0, na.rm = TRUE)) { #Checking that at least one 0 in the data
    next 
  }
  loop$val_binary <- ifelse(loop[,1] > 0, 1, 0) #Binary yes/no for zeros
  loop_tidy <- glm(val_binary ~ word_label,
                   data = loop,
                   family = binomial(link = "logit")) %>%
    tidy(conf.int = TRUE,
         exponentiate = TRUE) %>%
    select(term, estimate, conf.low, conf.high, p.value) #Zero-inflated model
  
  loop_tidy$val <- val
  zero_model_all <- rbind(zero_model_all, loop_tidy) #Adding results to final DF
      
  loop_part2 <- loop %>%
    filter(val_binary == 1) #Only keeping non-zero values

  if (length(unique(loop_part2$word_label)) == 1) { #Checking that both types of labels are in the filtered data set
    next
  }
  loop_tidy_part2 <- lm(get(val) ~ word_label,
                   data = loop_part2) %>%
    tidy(conf.int = TRUE) %>%
    select(term, estimate, conf.low, conf.high, p.value)
  
  loop_tidy_part2$val <- val
  nonzero_model_all <- rbind(nonzero_model_all, loop_tidy_part2)   
}

zero_model_all %<>%
  filter(term != "(Intercept)")

zero_model_all$p_value_adjusted <- p.adjust(zero_model_all$p.value, 
                                           method = "fdr")

nonzero_model_all %<>%
  filter(term != "(Intercept)")

nonzero_model_all$p_value_adjusted <- p.adjust(nonzero_model_all$p.value, 
                                           method = "fdr")

View(zero_model_all %>%
  filter(term != "(Intercept)") %>%
  mutate(estimate = round(estimate, 3),
         conf.low = round(conf.low, 3),
         conf.high = round(conf.high, 3),
         p_value_adjusted = round(p_value_adjusted, 3)) %>%
  select(term, val, estimate, conf.low, conf.high, p_value_adjusted))

View(nonzero_model_all %>%
  filter(term != "(Intercept)") %>%
  mutate(estimate = round(estimate, 3),
         conf.low = round(conf.low, 3),
         conf.high = round(conf.high, 3),
         p_value_adjusted = round(p_value_adjusted, 3)) %>%
  select(term, val, estimate, conf.low, conf.high, p_value_adjusted))
```

## Replotting F vs. M 
Excludes coefficients where Fact or Misinformation was not significantly different than Other
```{r}
nonzero_model_all_mf_sig <- nonzero_model_all %>%
  filter(grepl("Fact",
               term) |
           grepl("Misinformation", 
                 term)) %>%
  group_by(val) %>%
  filter(sum(p_value_adjusted, 
             na.rm = TRUE) < 0.05)

nonzero_model_fm %>%
  filter(is.na(conf.high) == FALSE &
           is.na(conf.low) == FALSE &
           val %in% nonzero_model_all_mf_sig$val) %>%
  mutate(facet = case_when(
    p_value_adjusted >= 0.05 ~ "Not Significant",
    p_value_adjusted < 0.05 & estimate > 0 ~ "Misinformation > Fact",
    p_value_adjusted < 0.05 & estimate < 0 ~ "Misinformation < Fact"
  )) %>%
  filter(p_value_adjusted < 0.05) %>%
  mutate(val_plot = case_when(
    val == "AllPunc" ~ "All Punctuation",
    val == "Sixltr" ~ "Words with At Least Six Letters",
    val == "compound" ~ "Compound Sentiment Score",
    val == "article" ~ "Function Words - Articles",
    val == "verb" ~ "Regular Verbs",
    val == "nonflu" ~ "Informal Speech - Nonfluencies",
    val == "function" ~ "Function Words",
    val == "cause" ~ "Cognitive Processes - Cause",
    val == "Apostro" ~ "Apostrophes",
    val == "home" ~ "Personal Concerns - Home",
    val == "negate" ~ "Negations",
    val == "death" ~ "Personal Concerns - Death",
    val == "focuspresent" ~ "Time Orientation - Present Focus")) %>%
  arrange(desc(estimate)) %>%
  group_by(facet) %>%
  mutate(absolute_estimate = abs(estimate)) %>%
  slice_max(absolute_estimate, n = 10, with_ties = T) %>%
  ggplot(aes(x = estimate, 
             y = reorder(val_plot, -estimate),
             color = facet)) + 
  geom_errorbar(aes(xmin=conf.low, 
                    xmax=conf.high), 
                width=0.2) +
  geom_point() +
  geom_vline(xintercept = 0,
             linetype = "dashed") + 
  scale_color_npg() + 
  #facet_wrap(~facet,
  #           scales = "free") + 
  labs(x = expression(beta),
       y = "Psycholinguistic Features",
       title = "Association Between Psycholinguistic Features and Label:\nFact vs. Misinformation, Top 10") +
  theme_classic() +
  theme(strip.text = element_text(size = 7),
        legend.position = "bottom",
        legend.title = element_blank())
setwd("~/Documents/dartmouth/research/aim2_reddit_misinformation_stigma/figures")
ggsave("211220_nonzero_regression_fm_nofacet.tiff", width = 7.25, height = 4.51)

```


## Replotting S vs. P
Excludes coefficients where Positivity or Stigma was not significantly different than Other
```{r}
nonzero_model_all_sp_sig <- nonzero_model_all %>%
  filter(grepl("Stigma",
               term) |
           grepl("Positivity", 
                 term)) %>%
  group_by(val) %>%
  filter(sum(p_value_adjusted, 
             na.rm = TRUE) < 0.05)

nonzero_model_ps %>%
  filter(is.na(conf.high) == FALSE &
           is.na(conf.low) == FALSE &
           val %in% nonzero_model_all_sp_sig$val) %>%
  mutate(facet = case_when(
    p_value_adjusted >= 0.05 ~ "Not Significant",
    p_value_adjusted < 0.05 & estimate > 0 ~ "Stigma > Positivity",
    p_value_adjusted < 0.05 & estimate < 0 ~ "Stigma < Positivity"
  )) %>%
  filter(p_value_adjusted < 0.05) %>%
  mutate(val_plot = case_when(
     val == "AllPunc" ~ "All Punctuation",
     val == "Sixltr" ~ "Words with At Least Six Letters",
     val == "i" ~ "First Person Singular Pronouns",
     val == "relativ" ~ "Relativity",
     val == "function" ~ "Total Function Words",
     val == "time" ~ "Relativity - Time",
     val == "ppron" ~ "Personal Pronouns",
     val == "focuspast" ~ "Time Orientation - Past Focus",
     val == "prep" ~ "Prepositions",
     val == "number" ~ "Numbers",
     val == "achieve" ~ "Core Drives and Needs - Achievement",
     val ==  "we" ~ "First Person Plural Pronouns",
     val == "sexual" ~ "Biological Processes - Sexual",
     val == "ipron" ~ "Impersonal Pronouns",
     val == "informal" ~ "Informal Language",
     val == "swear" ~ "Informal Language - Swear Words",
     val == "they" ~ "Third Person Plural Pronouns",
     val == "anger" ~ "Negative Emotions - Anger",
     val == "negemo" ~ "Negative Emotions",
     val == "social" ~ "Social Processes")) %>%
  arrange(desc(estimate)) %>%
  group_by(facet) %>%
  mutate(absolute_estimate = abs(estimate)) %>%
  slice_max(absolute_estimate, n = 10, with_ties = T) %>%
  ggplot(aes(x = estimate, 
             y = reorder(val_plot, -estimate),
             color = facet)) + 
  geom_errorbar(aes(xmin=conf.low, 
                    xmax=conf.high), 
                width=0.2) +
  geom_point() +
  geom_vline(xintercept = 0,
             linetype = "dashed") + 
  scale_color_npg() + 
  #facet_wrap(~facet,
  #           scales = "free") + 
  labs(x = expression(beta),
       y = "Psycholinguistic Features",
       title = "Association Between Psycholinguistic Features and Label:\nPositivity vs. Stigma, Top 10") +
  theme_classic() +
  theme(strip.text = element_text(size = 7),
        legend.position = "bottom",
        legend.title = element_blank())
setwd("~/Documents/dartmouth/research/aim2_reddit_misinformation_stigma/figures")
ggsave("211220_nonzero_regression_ps_nofacet.tiff", width = 7.25, height = 4.51)

```

